<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ARCOS — Architecture & Messaging (LinkPath + Title)</title>
<style>
  :root{--bg:#0b1020;--panel:#121933;--ink:#e8ecff;--muted:#9fb0ff;--accent:#7aa2ff;--bad:#ff7a7a}
  *{box-sizing:border-box}html,body{height:100%;margin:0}
  body{font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  header{padding:10px 16px;background:#0e1530;border-bottom:1px solid #24306b;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;font-weight:700}
  header .hint{color:var(--muted);font-size:12px}
  .wrap{display:grid;grid-template-columns:minmax(420px,1fr) minmax(520px,1.2fr);gap:12px;height:calc(100% - 56px);padding:12px}
  .panel{background:var(--panel);border:1px solid #1d2757;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .panel h2{margin:0;padding:10px 12px;font-size:14px;border-bottom:1px solid #1d2757;background:#121a3a}

  /* LEFT (SVG) */
  .svgbox{position:relative;flex:1;min-height:0;background:#0a0f22}
  .svgbox svg{display:block;width:100%;height:100%}
  .legend{padding:8px 12px;font-size:12px;color:var(--muted);border-top:1px solid #1d2757;background:#0f1733}

  /* RIGHT (tabs/viewer) */
  .tabs{display:flex;align-items:center;gap:8px;padding:6px 8px;background:#0f1735;border-bottom:1px solid #1d2757}
  .tab{padding:6px 10px;border-radius:8px;cursor:pointer;user-select:none;color:var(--muted);border:1px solid transparent}
  .tab.active{color:var(--ink);border-color:#2a3a7a;background:#12204a}
  .hidden{display:none!important}.disabled{opacity:.5;pointer-events:none}
  .viewer{position:relative;flex:1;min-height:0}
  .pane{display:none;height:100%}.pane.active{display:block}
  .code{margin:0;height:100%;overflow:auto;padding:12px;line-height:1.45;font:13px/1.45 ui-monospace,Menlo,Consolas,"Liberation Mono",monospace;white-space:pre-wrap}

  /* Image preview */
  .imgwrap{position:relative;height:100%;background:#0a0f22;overflow:hidden}
  .img-viewport{position:absolute;inset:0;transform-origin:0 0;will-change:transform}
  .img-viewport img{user-select:none;-webkit-user-drag:none;max-width:none;max-height:none;display:block}

  /* Toolbar */
  .toolbar{display:flex;align-items:center;gap:8px;padding:8px 12px;border-top:1px solid #1d2757;background:#0f1735;color:var(--muted);font-size:12px;flex-wrap:wrap}
  .toolbar a{color:var(--accent)}
  .toolbar button{background:#14255a;border:1px solid #2b3b7a;color:var(--ink);padding:6px 10px;border-radius:8px;cursor:pointer}
  .toolbar button:hover{filter:brightness(1.1)}
  .status{margin-left:auto;opacity:.85}

  /* Context menu (ASCII labels) */
  .ctxmenu{position:absolute;background:#131b3a;border:1px solid #2a3872;box-shadow:0 6px 18px rgba(0,0,0,.35);border-radius:8px;min-width:160px;z-index:20;display:none}
  .ctxmenu button{all:unset;display:block;width:100%;padding:8px 12px;font-size:13px;cursor:pointer;color:var(--ink)}
  .ctxmenu button:hover{background:#1a2550}
</style>
</head>
<body>
<header>
  <h1>ARCOS — Architecture & Messaging</h1>
  <div class="hint">Clickable if a group has a &lt;title&gt; ending in .xsd/.xml/.zip AND a LinkPath in the same group. URL = LinkPath + Title (exact case). Graphics only for .xsd if the JPG exists: LinkPath + "jpg/" + basename + ".jpg".</div>
</header>

<div class="wrap">
  <!-- LEFT -->
  <section class="panel">
    <h2>Diagram</h2>
    <div class="svgbox" id="svgHost"><!-- inline SVG goes here --></div>
    <div class="legend" id="legend">Waiting for SVG…</div>
  </section>

  <!-- RIGHT -->
  <section class="panel">
    <h2 id="fileTitle">Viewer</h2>

    <div class="tabs">
      <div class="tab active" data-target="textPane" id="tabText">Text</div>
      <div class="tab hidden"  data-target="imagePane" id="tabGraphic">Graphic</div>
    </div>

    <div class="viewer">
      <div class="pane active" id="textPane">
        <pre class="code" id="code">Click a shape in the SVG…</pre>
      </div>

      <div class="pane" id="imagePane">
        <div class="imgwrap" id="imgWrap">
          <div class="img-viewport" id="imgViewport">
            <img id="previewImg" alt="Schema preview"/>
          </div>

          <!-- Right-click context menu -->
          <div class="ctxmenu" id="ctxMenu" role="menu" aria-label="Image menu">
            <button data-act="reset">Reset</button>
            <button data-act="fit">Fit</button>
            <button data-act="fitw">Fit Width</button>
            <button data-act="fith">Fit Height</button>
            <button data-act="100">Zoom 100%</button>
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <div class="group hidden" id="imgControls" aria-label="Image controls">
        <button id="zoomOutBtn" title="Zoom out">-</button>
        <button id="zoomInBtn"  title="Zoom in">+</button>
        <button id="resetBtn"   title="Reset (fit)">Reset</button>
        <button class="nudge" id="panUpBtn"    title="Pan up">UP</button>
        <button class="nudge" id="panLeftBtn"  title="Pan left">&lt;</button>
        <button class="nudge" id="panRightBtn" title="Pan right">&gt;</button>
        <button class="nudge" id="panDownBtn"  title="Pan down">DOWN</button>
      </div>

      <button id="copyBtn" class="disabled" title="Copy">Copy</button>
      <a id="openRaw" class="disabled" href="#" target="_blank" rel="noopener">Open raw file</a>

      <span class="status" id="status">Ready.</span>
    </div>
  </section>
</div>

<script>
(function(){
  /* ===== 1) Load SVG inline from GitHub RAW ===== */
  const svgUrl = "https://raw.githubusercontent.com/ARCOS-System/ARCOS/main/1-Docs/svg/ARCOS-Architecture-RAE-SGD.svg";
  const svgHost = document.getElementById('svgHost');
  const legend  = document.getElementById('legend');

  function sanitiseTitle(t){
    if(!t) return null;
    const s = String(t).trim();
    // capture last token ending with .xml/.xsd/.zip (case-insensitive), preserve exact case
    const m = s.match(/([A-Za-z0-9_.-]+\.(?:xml|xsd|zip))\s*$/i);
    return m ? m[1] : null;
  }

  function findLinkPathFor(group){
    // 1) <LinkPath path="…"/>
    const lpAttr = group.querySelector(':scope > LinkPath[path]');
    if(lpAttr){ const v = lpAttr.getAttribute('path'); if(v) return v.trim(); }
    // 2) <LinkPath>…</LinkPath>
    const lpText = group.querySelector(':scope > LinkPath');
    if(lpText && lpText.firstChild && lpText.textContent.trim()) return lpText.textContent.trim();
    // 3) <desc>…LinkPath="…"</desc>
    const desc = group.querySelector(':scope > desc');
    if(desc){
      const m = String(desc.textContent||'').match(/LinkPath\s*=\s*["']?([^\s"']+)/i);
      if(m) return m[1];
    }
    return null;
  }

  function markClickable(g, fileName, linkBase){
    try{ g.style.cursor = 'pointer'; }catch(_){}
    g.addEventListener('click', ()=> openFile(fileName, linkBase));
  }

  fetch(svgUrl, {cache:'no-store'})
    .then(r => { if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.text(); })
    .then(txt => {
      svgHost.innerHTML = txt;

      const svgRoot = svgHost.querySelector('svg');
      if(!svgRoot){ legend.textContent = 'Inline SVG not found in response.'; return; }

      // Make responsive and clickable
      svgRoot.removeAttribute('width');
      svgRoot.removeAttribute('height');
      if(!svgRoot.hasAttribute('viewBox')){
        // best-effort fallback if no viewBox (rare)
        const bb = svgRoot.getBBox?.(); if(bb) svgRoot.setAttribute('viewBox', [bb.x,bb.y,bb.width,bb.height].join(' '));
      }
      if(!svgRoot.hasAttribute('preserveAspectRatio')) svgRoot.setAttribute('preserveAspectRatio','xMidYMid meet');

      // Ensure groups receive pointer events
      svgRoot.querySelectorAll('g').forEach(g=>{
        const pe = (g.style && g.style.pointerEvents) || '';
        if(pe === 'none') g.style.pointerEvents = 'all';
      });

      // Wire clickable groups
      let candidates=0, wired=0, withLP=0;
      svgRoot.querySelectorAll('g > title').forEach(tt=>{
        const g = tt.parentElement;
        const fname = sanitiseTitle(tt.textContent);
        if(!fname) return;
        candidates++;
        const base = findLinkPathFor(g);
        if(base) withLP++;
        if(!base) return;
        markClickable(g, fname, base);
        wired++;
      });

      legend.innerHTML = wired
        ? 'Clickable groups: <b>'+wired+'</b> (with LinkPath: '+withLP+', titles: '+candidates+')'
        : 'No clickable targets detected. Need a &lt;title&gt; ending in .xsd/.xml/.zip and a sibling LinkPath.';
    })
    .catch(err => { legend.textContent = 'Failed to load inline SVG: ' + err.message; });

  /* ===== 2) Viewer logic (unchanged behavior) ===== */
  const fileTitle = document.getElementById('fileTitle');
  const code = document.getElementById('code');
  const statusEl = document.getElementById('status');
  const openRaw = document.getElementById('openRaw');
  const previewImg = document.getElementById('previewImg');
  const imgControls = document.getElementById('imgControls');

  function flashStatus(msg, bad){
    statusEl.textContent = msg;
    statusEl.style.color = bad ? 'var(--bad)' : 'var(--ink)';
    setTimeout(()=>{ statusEl.textContent='Ready.'; statusEl.style.color='var(--muted)'; }, 2000);
  }

  async function openFile(fileName, linkBase){
    const base = fileName.replace(/\.(xml|xsd|zip)$/i,'');
    const rawTextUrl = linkBase + fileName;                 // exact case
    const rawImgUrl  = linkBase + 'jpg/' + base + '.jpg';   // for .xsd only

    fileTitle.textContent = fileName;
    openRaw.classList.remove('disabled'); openRaw.href = rawTextUrl;

    // fetch text
    code.textContent = 'Loading ' + rawTextUrl + ' …';
    try{
      const r = await fetch(rawTextUrl, {mode:'cors'});
      if(!r.ok) throw new Error(r.status + ' ' + r.statusText);
      const txt = await r.text();
      code.textContent = txt;
      // show Text tab
      activateTab('textPane');
      imgControls.classList.add('hidden');
    }catch(e){
      code.textContent = 'Failed to fetch text: ' + e.message + '\n' + rawTextUrl;
    }

    // graphic only for .xsd if image exists
    if(/\.(xsd)$/i.test(fileName)){
      const test = new Image();
      test.onload = ()=>{
        previewImg.src = rawImgUrl + '?v=' + Date.now();
        document.getElementById('tabGraphic').classList.remove('hidden');
      };
      test.onerror = ()=>{
        previewImg.removeAttribute('src');
        document.getElementById('tabGraphic').classList.add('hidden');
      };
      test.src = rawImgUrl + '?v=' + Date.now();
    } else {
      previewImg.removeAttribute('src');
      document.getElementById('tabGraphic').classList.add('hidden');
    }
  }

  // Tabs
  function activateTab(targetId){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
    const tab = document.querySelector(`.tab[data-target="${targetId}"]`);
    const pane = document.getElementById(targetId);
    if(tab) tab.classList.add('active');
    if(pane) pane.classList.add('active');
    if(targetId==='imagePane' && document.getElementById('previewImg').src){
      imgControls.classList.remove('hidden');
    } else {
      imgControls.classList.add('hidden');
    }
  }
  document.getElementById('tabText').addEventListener('click', ()=> activateTab('textPane'));
  document.getElementById('tabGraphic').addEventListener('click', ()=> activateTab('imagePane'));

  // Copy
  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(code.textContent); flashStatus('Copied to clipboard'); }
    catch(e){ flashStatus('Copy failed: ' + e.message, true); }
  });

  // Zoom/Pan
  const imgWrap = document.getElementById('imgWrap');
  const imgViewport = document.getElementById('imgViewport');
  const ctxMenu = document.getElementById('ctxMenu');
  const view = {x:0,y:0,scale:1,min:0.25,max:8};

  function applyTransform(){ imgViewport.style.transform = `translate(${view.x}px,${view.y}px) scale(${view.scale})`; }
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function fitPreview(){
    if(!previewImg.naturalWidth || !imgWrap.clientWidth) return;
    const W = imgWrap.clientWidth, H = imgWrap.clientHeight;
    const s = Math.min(W/previewImg.naturalWidth, H/previewImg.naturalHeight);
    view.scale = clamp(s, view.min, view.max);
    const w = previewImg.naturalWidth*view.scale, h = previewImg.naturalHeight*view.scale;
    view.x=(W-w)/2; view.y=(H-h)/2; applyTransform();
  }
  function zoomAt(cx,cy,factor){
    const rect = imgWrap.getBoundingClientRect();
    const vx=cx-rect.left, vy=cy-rect.top;
    const old=view.scale, next=clamp(old*factor, view.min, view.max);
    if(next===old) return;
    const rx=(vx-view.x)/old, ry=(vy-view.y)/old;
    view.x = vx - rx*next; view.y = vy - ry*next; view.scale = next; applyTransform();
  }
  function panBy(dx,dy){ view.x+=dx; view.y+=dy; applyTransform(); }

  document.getElementById('zoomInBtn').addEventListener('click', ()=>{ const r=imgWrap.getBoundingClientRect(); zoomAt(r.left+r.width/2, r.top+r.height/2, 1.2); });
  document.getElementById('zoomOutBtn').addEventListener('click',()=>{ const r=imgWrap.getBoundingClientRect(); zoomAt(r.left+r.width/2, r.top+r.height/2, 1/1.2); });
  document.getElementById('resetBtn').addEventListener('click', fitPreview);

  const STEP=40;
  document.getElementById('panUpBtn').addEventListener('click',   ()=> panBy(0,  STEP));
  document.getElementById('panDownBtn').addEventListener('click', ()=> panBy(0, -STEP));
  document.getElementById('panLeftBtn').addEventListener('click', ()=> panBy( STEP, 0));
  document.getElementById('panRightBtn').addEventListener('click',()=> panBy(-STEP, 0));

  imgWrap.addEventListener('wheel',(e)=>{ e.preventDefault(); zoomAt(e.clientX,e.clientY, e.deltaY<0?1.15:1/1.15); },{passive:false});

  let dragging=false,lx=0,ly=0;
  imgWrap.addEventListener('pointerdown',(e)=>{ dragging=true; lx=e.clientX; ly=e.clientY; imgWrap.setPointerCapture(e.pointerId); imgWrap.style.cursor='grabbing'; });
  function endDrag(e){ if(!dragging) return; dragging=false; try{imgWrap.releasePointerCapture(e.pointerId);}catch{} imgWrap.style.cursor='default'; }
  imgWrap.addEventListener('pointermove',(e)=>{ if(!dragging) return; panBy(e.clientX-lx, e.clientY-ly); lx=e.clientX; ly=e.clientY; });
  imgWrap.addEventListener('pointerup',endDrag);
  imgWrap.addEventListener('pointercancel',endDrag);
  imgWrap.addEventListener('pointerleave',endDrag);

  imgWrap.addEventListener('contextmenu',(e)=>{
    e.preventDefault();
    const rect = imgWrap.getBoundingClientRect();
    ctxMenu.style.display='block';
    ctxMenu.style.left = Math.min(e.clientX-rect.left, rect.width-ctxMenu.offsetWidth-4) + 'px';
    ctxMenu.style.top  = Math.min(e.clientY-rect.top,  rect.height-ctxMenu.offsetHeight-4) + 'px';
  });
  document.addEventListener('click',(e)=>{ if(!e.target.closest('#ctxMenu')) ctxMenu.style.display='none'; });
  ctxMenu.addEventListener('click',(e)=>{
    const act = e.target.getAttribute('data-act'); if(!act) return;
    ctxMenu.style.display='none';
    if(act==='reset' || act==='fit') fitPreview();
    else if(act==='fitw'){ view.scale=clamp(imgWrap.clientWidth/previewImg.naturalWidth,view.min,view.max); view.x=0; view.y=(imgWrap.clientHeight - previewImg.naturalHeight*view.scale)/2; applyTransform(); }
    else if(act==='fith'){ view.scale=clamp(imgWrap.clientHeight/previewImg.naturalHeight,view.min,view.max); view.y=0; view.x=(imgWrap.clientWidth - previewImg.naturalWidth*view.scale)/2; applyTransform(); }
    else if(act==='100'){ view.scale=1; view.x=(imgWrap.clientWidth - previewImg.naturalWidth)/2; view.y=(imgWrap.clientHeight - previewImg.naturalHeight)/2; applyTransform(); }
  });

  // Fit image whenever it loads or pane becomes visible
  document.getElementById('tabGraphic').addEventListener('click', fitPreview);
  document.getElementById('previewImg').addEventListener('load', fitPreview);
})();
</script>
</body>
</html>
